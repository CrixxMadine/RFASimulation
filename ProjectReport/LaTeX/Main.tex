
% Document type and layout
\documentclass[parskip=half, titlepage=yes, 12pt, BCOR=12mm, DIV=calc]{scrartcl}

% Praeambel = definition of layout and packages
\input{Praeambel}


\usepackage{amsthm}
\usepackage{lipsum}

%% Actual document
\begin{document}


% Title and registers
\maketitle
\tableofcontents

\clearpage

% \listoffigures
% \listoftables
% \lstlistoflistings
% \clearpage


% part 1, Introduction 

\section{Introduction to Radio Frequency Ablation}
Radio frequency ablation is a modern minimally invasive practice in surgery . In medicine it is mainly used to destroy human tissue. The two main areas of application are the medical treatment of tumours, as it destroys the malignant tissue, and also the treatment of chronic pain patients, as it can destroy nerve fibres that conduct pain signals to the brain. In the process, needles with electrodes are inserted into the patient. An external generator applies electricity and the heat generated by the electrodes increases the temperature of the tissue. The process is usually used in the temperature range of 70 to 100 degrees Celsius. A therapy session lasts for the patient from 20 minutes to several hours, depending on the need and case.
Radio Frequency Ablation (RFA) has been proven to be one of the best therapies for small tumors, which means areas smaller than 5 cm, in the human liver and kidney. The use of this treatment in modern medicine is increasing, as is the interest in research in this field. 
One of the largest branches of research is the simulation of such a therapy. Experimental research is usually based either on real patients or alternatively on animal organs such as the livers of pigs. Since experimental practice is generally very cumbersome, the interest in simulating such processes was there from the very beginning.  
With a stable and converging simulation model it is easier to try out different modifications and configurations of the process. Of course, these simulations are by no means a substitute for experimental practice, but they are a valuable addition to research. 
On a larger scale, the simulation of this process is used with virtual reality simulation programs to train physicians and surgeons in this process.\\

\begin{figure}[H]
    \centering
    \includegraphics[width=0.75\textwidth]{pictures/ra_kidney_2.jpg}
    \caption{Schematic illustration of Radio Frequency Ablation}
    \label{fig:ra_kidney_2}
\end{figure}

This is the documentation of an academic approach to numerical finite element simulation. A model for the simulation of radio frequency ablation is used as the underlying time-dependent problem.
The main purpose of this project is to study the finite element method and its convergence behaviour in an academic setting, rather than to verify a realistic simulation of radio frequency ablation. 
The underlying RFA model is described as a three-dimensional coupled system of time-dependent partial differential equations. In this investigation the model is computed in 2D space with discrete time solutions. By modeling a single needle, the original 3D domain has a rotational symmetry around the needle. The rotationally symmetric 3D model can thus be described with 2D ring elements on a cross-section and special finite element techniques. 
All algorithms were implemented with the mathematical programming tool MatLab from MathWorks.


% part 2, Main

\section{Simulation of radio frequency ablation}

\subsection{Discrete Numerical Simulation}
Physical relations can usually be described by physical laws, which in turn can be described by mathematical relations. 
Usually, the descriptions represent highly complex systems, which in turn are described by ODEs, PDEs and statistics.
In real-world physics, these models are limited by boundary conditions that allow the calculation of certain solutions of the mathematical modeling. 
In most areas of physics, with the exception of quantum mechanics and modern theoretical physics, rough models can be formulated for which concrete solutions can be found. 
Since the physics of our world is determined to a certain degree, investigations can also be carried out with the help of computer-aided simulations instead of experiments and measurements. 
Properly performed simulations can be easily modified and adapted to different models and limits. \\

In practice, the geometric dimensions of most problem descriptions are very irregular.
In many cases, there is no reasonable analytical approach to solve these problems, especially in engineering applications. For this purpose, more and more improved numerical methods have been developed in the last decades. 
Instead of a smooth analytical solution, an approximation is calculated with sufficiently high accuracy.\\

For the numerical solution of partial differential equations, the methods of finite differences, finite elements, finite volumes and boundary elements have become widely accepted in practice.
In this simulation approach, a model of radio frequency ablations is discretised and computed with common finite element techniques. \\




\subsection{About Errors in simulations and numerical approaches}

The numerical simulation of physical processes leads along the whole process from the description of the real problem up to the discrete solution to various sources of error.

\begin{itemize}
    \item Idealization errors, the discrepancy between reality and idealized reality and idealized constitutive laws and boundary conditions. In reality, physical relationships are often much more complex than the mathematical assumptions and side effects are often neglected.
    
    \item Modelling errors, the discrepancy between mathematical formulation and physical model. Often physical assumptions in the mathematical description are represented by dimensionally reduced approaches, such as linear dependencies or invariant parameters.
    
    \item  Discretization error, the discrepancy between the continuous description of the problem and the transfer to a discretized description. Discretization is in most cases merely a sufficiently accurate approximation to the continuum.
    
    \item Solution errors, caused by the use of iterative approximation methods and generally rounding errors within the scope of calculation accuracy. Beside the limited computing resources in general, it has to be considered that exact calculations are mostly not useful, because the underlying modeling also represents only an idealized estimation in the context of the error sources described above.
    
\end{itemize}


Sources of error basically cause a butterfly effect, the earlier approximations are made, the greater the inaccuracy of the simulation results. In addition, the sources of error are often in antinomic relationships to each other, i.e. the optimization of one source of error is itself in conflict with another. For example, the modeling of nonlinear dependencies requires more complex solution algorithms which in turn generate new numerical sources of error. Further information on this topic can be found in this dissertation by Sorger \cite{sorger}.


\subsection{The physics behind radio frequency ablation}
The underlying physical processes of radio frequency ablation can be described relatively straightforwardly.
Needles with electrodes (either monopolar or bipolar) are inserted into the damaged tissue. The attached electrodes create a quasi-static potential in the target tissue. Outside the target tissue, the potential is removed in a controlled manner with the help of an additionally applied mass. \\

Electrical power is generated by an external generator using the quasi-static potential. This power supply is the basis for the electrically generated energy in the area of the probes.
In principle, energy is not lost and the tissue resistance converts the energy into heat. \\

The heat generated is distributed throughout the tissue, which is why the temperature in the target area rises continuously. 
In addition, the blood circulation causes a cooling effect through heat dissipation. The controlled temperature increase in the tissue kills the damaged target tissue. The entire process is controlled from the outside to keep the temperature in the ideal target area. \\

Therefore the interesting result we are looking for is the discrete temperature distribution $\si{T}$ over time. \\

The following description is derived from a RFA model by Kr√∂ger \cite{kroeger}.This description serves to illustrate the physical relationships. An adaptation to the calculation domain $\Omega$ will follow later.

For simplicity, all material parameters are considered constant. In reality, the material parameters are strongly non-linearly dependent on both the temperature and the personal body conditions of the individual patient. Research on this aspect can be found at Stein \cite{stein} and Watanabe \cite{watanabe}. \\


The electrical energy $E_{el}(x,y,z,t)$ is calculated from the electrical power $p$.This in turn is determined by the potential $varphi$ in the calculation area. Ignoring boundaries, $\varphi$ is defined as following:
\begin{equation}
    - \nabla \cdot (\sigma(x,y,z,t) \nabla \varphi(x,y,z,t)) = 0
\end{equation}

Where $\sigma$ is the electric conductivity of the surrounding tissue. \\
The power applied by the probe is therefore obtained by the following relationship:
\begin{equation}
    p(x,y,z,t) = \sigma(x,y,z,t) \cdot |\nabla \varphi(x,y,z,t)|^2
\end{equation}

The actual potential induced by the generator can be acquired by a scaling, taking into account the non-linear behaviour of the power supply due to tissue resistance. Therefore the effective power $p_{eff} $can be modeled as following:   
\begin{equation}
    p_{eff}(t) = \frac{4 \cdot p_{setup} \cdot R_{tis}(t) \cdot R_I}{(R_{tis}(t) + R_I)^2}
\end{equation}

Where $R_{tis}$ is the tissue resistance, $R_I$ is the inner resistance of the generator, $p_{setup}$ is the initial setup power of the generator $U$ the potential difference between the electrodes.

The total power $p_{total}$ is obtained by the domain integral over the power distribution.
\begin{equation}
    p_{total}(t) = \int_{\Omega} p(x,y,z,t) dx
\end{equation}

Tissue resistance is therefore modeled as linear depending on the total power.
\begin{equation}
    R_{tis}(t) = \frac{U^2}{p_{total}(t)}
\end{equation}

From these quantities, the electric energy can be calculated.
\begin{equation}
   E_{el}(x,y,z,t) = p(x,y,z,t) \cdot \frac{p_{eff}(t)}{p_{total}(t)} = Q_{rf}(x,y,z,t)
\end{equation}


Since no energy is lost, the generated electrical energy becomes heat energy $Q_{rf}$ by tissue resistance. \\

The energy generated causes the temperature to rise. The exact temperature distribution $T$ is described by the well known heat equation:

\begin{equation}
    \partial_t (\rho(x,y,z,t) \cdot c(x,y,z,t,) \cdot T(x,y,z,t)) - \nabla \cdot (\lambda(x,y,z,t) \cdot \nabla T(x,y,z,t)) = Q_{total}(x,y,z,t)
\end{equation}

Referring to the parameters above, $\rho$ is the density, $c$ is the specific heat capacity and $\lambda$ represents the thermal conductivity of the tissue, which are all highly dependent on the temperature $T$. \\
The total heat energy $Q_{total}$ on the right hand side is basically the sum of all contributing heat sources and sinks. A very simplified approach leads to the following relationships:
\begin{equation}
    Q_{total} = Q_{rf} + Q_{perf}
\end{equation}

Where $Q_{rf}$ is descripted above and $Q_{perf}$ models the additional cooling effect due to blood perfusion, which is given by the following equation:
\begin{equation}
    Q_{perf}(x,y,z,t) = \nu_{perf} \cdot \rho_{blood} c_{vlood} \cdot (T_{body} - T(x,y,z,t))
\end{equation}
 
 Where $\nu_{perf}$ serves as an additional perfusion coefficient.

This model serves as a basis for time-dependent discrete numerical simulation. As mentioned in the beginning, the geometric calculation area is discretised on a 2D half-section, which represents an axis-symmetric 3D geometry. 


\section{Finite elements for discrete simulation}

\subsection{Elliptical problems}
- Elliptical problems in general \\
- build up system of PDE's to describe problem \\

- Ritz-Galerkin-Verfahren, for Details see ref book TODO \\
- This documentation will be focused on the 3D -> 2D aspect


- Using the cylindric domain, different domains, will be described later \\


- Systems of equations by finite number of elements calculated with shape function \\
- weak solution solution is approximation of real solution \\


- Dirichlet with trick, define value to be solution of variable \\
- TODO \\


- Neumann boundary with curve integral \\
\begin{equation}
    f = f_{vol} + f_{surf}
\end{equation}

\begin{equation}
    b = \int_{\Gamma_2} g \cdot \phi_{i} d S 
\end{equation}

- Note : In 2D dimension the surface integral is around the boundary line \\
- For natural boundary conditions $g(x) = 0$, the surface integral added is zero, which is a trivial solution \\

\subsection{Parabolic problems}
- Parabolic / time-dependent problems \\
- Usually involve an elliptic problem with additional time dependent factor \\

- Time dependecy can be modeled continuously or in discrete intervalls \\
- Discrete intervalls are is typically more practical in modeling but less efficient or exact \\
- Discrete intervalls can be refined if necessary \\

- Ignoring time dependency at first and calculate the resulting elliptical problem \\
- Build system of equations for elliptical problem \\

- Describe the parabolic PDE as an ODE with matrices from elliptical PDE \\
- Solving the system of ODE equations over discrete time intervalls \\
- Runge-Kutta \\
- For this simulation, backward euler / implicit euler formula does the job \\



\subsection{Axial symmetrie}
- In general, symmetrie should be used to reduce complexity whereever possible \\
- Using axial symmetrie allows to reduce the domain from a 3D problem to a 2D cross-section \\
- Thus this is to simplify and reduce time for computations \\
- In a truely axial symmetric domain, the problem on the cross-section is aquivalent, which will be shown later \\
- The allows significant savings on calculations time and complexity in general \\
- approach: fourier decomposition in angular direction to reduce dependency on the angular $\varphi$ \\

\begin{figure}[H]
    \centering
    \includegraphics[width=1.0\textwidth]{projection_2D_general.PNG}
    \caption{Schematic projection on 2D half section}
    \label{projection_2D_general}
\end{figure}


- TODO: write this more formal
- Lax-Milgram-Lemma and Poincar√© inequality on 3D-Domain determine a unique solution \\
- $u \in H^{1}_{r}(\Omega) \cap \{ v|_{\Gamma_{0}} \}  $
- Trace-operator \\
- rotation axis becomes an artificial boundary on 2D half section \\

- A more formal description can be found in : \\
- Use input from article TODO \\


\section{Discretization of PDEs}

\subsection{Computational domain}

When simulating one single probe and using homogeneous and constant material parameters, the entire calculation area is axisymmetric around the needle. To make this symmetry usable for simplifying complexity, the problem has to be adapted according to the symmetry. The partial differential equations are reduced to a 2D problem by using ring elements and cylindrical coordinates, whereby the dependence on the angle is completely eliminated. \\

The calculation area used is shown below. It is sufficient to use only half of the presented calculation area. The full cross section serves at this point for a better understanding of the geometry and is later used for plausibility checks of the simulation results.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\textwidth]{pictures/Grid_Explanation_full.PNG}
    \caption{2D cross-section of the axis symmetric calculation domain}
    \label{fig:Grid_Explanation_full}
\end{figure}

\subsection{FEM in cylindrical Coordinates}

The equations described above refer to a Cartesian coordinate system. In order to exploit the rotational symmetry, all calculations of the domain must be adapted to cylindrical coordinates and the equations must be transformed accordingly. As an example, the Laplace operator in cylindrical coordinates is given here, which is used to describe the two partial differential equations.
 
Laplace in cartesian coordinates:
\begin{equation}
    \nabla^2 := \Delta := \frac{\partial^2}{\partial x^2} + \frac{\partial^2}{\partial y^2} + \frac{\partial^2}{\partial z^2}
\end{equation}

Laplace in cylindrical coordinates:
\begin{equation}
    \Delta := \frac{\partial^2}{\partial r^2} + \frac{1}{r} \frac{\partial}{\partial r} + \frac{1}{r^2} \frac{\partial^2}{\partial \phi^2} + \frac{\partial^2}{\partial z^2}
\end{equation}



\subsection{PDE for Electric potential}

\subsubsection{Discretization of the domain}

From a mathematical point of view, 4 different areas of the computational domain are of interest:
\begin{itemize}
    \item Inner area between the boundaries
    \item Electrodes 
    \item Rest of the sample and the outer boundaries
    \item Artificial boundary on the rotation axis
\end{itemize}

As mentioned above, only constant material parameters are assumed. This results in essential simplifications for the further calculation.

\subsubsection{Inner Domain}

The electrical potential in the inner domain behaves as described above:
\begin{equation}
    - \nabla \cdot (\sigma(x,y,z,t) \nabla \varphi(x,y,z,t)) = 0
\end{equation}

As sigma is assumed to be constant the following relation is valid:
\begin{equation}
    \nabla \cdot \sigma = 0
\end{equation}

Trivially this equation is now independent of $\sigma$, so $\sigma$ can be easily removed. The partial differential equation becomes the Laplace equation and $\varphi$ becomes time independent.
\begin{equation}
    - \Delta \varphi(x,y,z) = 0
\end{equation}

Adapted to the domain, the axis symmetry is exploited by using cylindrical coordinates.
\begin{equation}
    - \Delta \varphi(r,\phi,z) = - \frac{1}{r} \frac{\partial \varphi}{\partial r} - \frac{\partial^2 \varphi}{\partial r^2} - \frac{1}{r^2} \frac{\partial^2 \varphi}{\partial \phi^2} -      \frac{\partial^2 \varphi}{\partial z^2}  = 0
\end{equation}

Because of the axial symmetry, the solution for $\varphi$ is independent of the angle $\phi$. The PDE is thus reduced by one dimension. 
\begin{equation}
    - \nabla  ( \sigma \cdot \nabla \varphi(r,\phi,z)) \overset{!}{=} - \Delta \varphi(r,z) = - \frac{1}{r} \frac{\partial \varphi}{\partial r} - \frac{\partial^2 \varphi}{\partial r^2} - \frac{\partial^2 \varphi}{\partial z^2} = 0
\end{equation}

To keep the following descriptions clearer, the explicit specification of coordinates is omitted. $\varphi$ is dependent on $r$ and $z$ unless otherwise specified.

\subsubsection{Electrodes}

The potential difference at the electrodes is fixed by definition. For the calculations the potential is defined as $\pm 1$ arbitrarily chosen. Since only one needle is modeled, it has a positive and negative electrode each.
\begin{equation}
    \varphi = \pm 1
\end{equation}

Other values are also possible in principle, but are not useful for this modelling.

\subsubsection{Outer boundary}

To make the calculation as reasonable as possible, it is assumed that all other outer edges have natural Neumann boundary conditions for the electric potential $\varphi$. Although this does not exactly reflect the physical conditions of the potential, it is very appropriate in the context of the simplifications made.
\begin{equation}
    n \cdot \nabla \varphi = 0
\end{equation}

In addition to the electrodes, a mass is applied in the RFA treatment to nullify the potential in the outer regions. This behavior is simulated by assuming fixed Dirichlet values at the lower edge.
\begin{equation}
    \varphi = 0
\end{equation}

Neither the Neumann nor the Dirichlet conditions correctly reflect the underlying physics, but are rather rough simplifications.
Since further simplifications in the modeling were already made in the run-up, especially by the unrealistic assumption of constant material parameters, these simplifications of the boundary conditions are within the range of acceptable errors.


\subsubsection{Rotation axis}

The edge on the symmetry axis is purely artificial and a product of dimensional reduction. For reasons of maintaining symmetry, it is easy to see that natural boundary conditions apply here.
A formal and detailed investigation of this statement can be found in the publication of Hengguang \cite{hengguang}. 

- \begin{equation}
    n \cdot \nabla \varphi = 0
\end{equation}



\subsection{Calculation of electrical energy}

- $\varphi$ can be calculated on every discrete point \\
- Calculate power for every point with equations above (TODO add ref here) \\
- Phi is evaluated on discrete mesh points \\
- In a nutshell, Tissue Resistance and nonlinear behaviour of the generator generate an effective power which is as well the total power of the domain  a scalar multiplication factor for every discrete value for phi \\

- Thus leading to the calculation of the electric energy from electric power above \\


\subsection{PDE for temperature Distribution}

\subsubsection{Discretization of the problem}

From physics above, the temperature distribution is modeled by the heat equation: 

\begin{equation}
    \partial_t (\rho c T) - \nabla \cdot (\lambda \nabla T) = Q
\end{equation}

The heat equation is a well known parabolic partial differential equation. \\

T = T(r,z,t) = temperature \\
Q = Q(r,z,t) = heat energy \\

The material parameters are taken as constant, as described above \\
$\rho$ = density \\
$c$ = specific heat capacity, \\
$\lambda$ = thermal conductivity \\
- In temperature range of radio frequency ablation, $c$ and $\lambda$ are especially nonlinear depending on the temperature, for which the phase change of water is reason to \\ Evaporated water has a totally different heat capacity and thermal conductivty, also the transition is smooth and not abrupt \\


- However, Modeling the phase change of water and corresponding heat capacity does in practise lead to big numerical problems \\

- It is reasonable to at least model the temperature dependency of lambda, which leads to the following description

Cylindrical coordinates: see 'Transient Heat Transfer in a Partially Cooled Cylindrical Rod' from Lawrence Agbezuge

\begin{equation}
    \rho c \frac{\partial T}{\partial t} -  \frac{d\lambda}{dT} \left[ \left( \frac{\partial T}{\partial r} \right)^2 + \left( \frac{\partial T}{\partial z} \right)^2 \right] - \lambda \left( \frac{\partial^2 T}{\partial r^2} + \frac{1}{r} \frac{\partial T}{\partial r} + \frac{\partial^2 T}{\partial z^2} \right) = Q
\end{equation}

- For sake of simplicity in this academic approach, we will ignore the phase change of water willingly as a whole \\

- So it is "good" to assume that $lambda$ would also be constant too, which greatly reduces the complexity of the whole PDE \\

\begin{equation}
    \rho c \frac{\partial T}{\partial t} - \lambda \left( \frac{\partial^2 T}{\partial r^2} + \frac{1}{r} \frac{\partial T}{\partial r} + \frac{\partial^2 T}{\partial z^2} \right) = Q
\end{equation}

- The right hand side is described in the physics, see ref\\
- It is depending on the generated electrical energy and the cooling effect of perfusion \\

\begin{equation}
    Q_{total} = Q_{rf} + Q_{perf}
\end{equation}

- Since the material parameters are constant, $Q_{perf}$ can be easily evaluated linear depending on T for every discrete time step \\

\subsubsection{Needle}

- If we assume that the probe is cooled from outside, it is as simple and also accurate assumption to take the body temperature as constant temperature for the probe over the whole intervall
\begin{equation}
    T = T_{body} \
\end{equation}

- Usually body temperature is around $\cong$ 37 degree Celsius or 310.15 degree Kelvin \\
- If the probe is not cooled, another simple approach is to model the behaviour of needle likewise as the outer boundary \\  

\subsubsection{Outer boundary}

- Assuming there is no "Disturbing" from outside, natural boundary conditions conditions are the correct assumption for the heat equation  

- \begin{equation}
    n \cdot \nabla \varphi = 0
\end{equation}

- These can also be used to model non cooled probes \\

- In the following, we will discribe how the PDE models for $\varphi$ and $T$ can be transformed in the context of finite elements and numerically evaluated at discrete points \\


\section{Applied FEM technologies}

\subsection{Weak solutions}
\subsubsection{Electric potential}

For the Ritz-Galerkin method, it is mandatory to transform the PDEs above into weak formulations. Poisson's equation is given as follows:

\begin{equation}
    a_w(u,v) := \int_{\Omega} (\partial_r u \partial_r v + \partial_z u \partial_z v) r drdz = \int_{\Omega} f v r dr dz
\end{equation}

\begin{align}
    u \in H_r^1(\Omega) \cap \{v|_{\Gamma_{0}} &= 0 \} 
    \label{trial_functions1}\\
    v \in H_r^1(\Omega) \cap \{v|_{\Gamma_{0}} &= 0 \}     
    \label{trial_functions2}
\end{align}

More information about the above transformation for Laplace's equation as well as a detailed proof of conformity can be found in the work of Hengguang \cite{hengguang}. \\

This formulation leads analogously to the following description of the electric potential $\varphi$ for the inner domain: 

\begin{equation}
    a_w(u,v) := \int_{\Omega} (\partial_r u \partial_r v + \partial_z u \partial_z v) r drdz = 0 
\end{equation}

Using the same trial functions as described above (\ref{trial_functions1}) (\ref{trial_functions2}).  

\subsubsection{Temperature Distribution}

The temperature distribution as a hyperbolic problem can be described as a fully discrete substitute problem by discontinuous Galerkin FEM. The variation problem consists of a local discretization of the Laplace problem and a subsequent discretization in the time dimension.   

 A weak formulation of the problem can be described as follows: \\

We are looking for $u(r,z,t) \in V_{g1}$ with $\Dot{u} \in L_2(\Omega)$ for almost every $t \in (0,T)$, so \\ \begin{equation}
(\Dot{u},v)_0 + a(t;u,v) = \langle F(t),v \rangle \; for \; all \; v \in V_0    
\end{equation}
and for almost every $t \in (0, T)$ is the condition given as 
\begin{equation}
    (u(r,z,0),v)_0 = (u_0,v)_0 \; for \; all \; v \in V_0
\end{equation}

The formal description is given by 
\begin{align*}
    (\Dot{u},v)_0 &= \int_{\Omega} \Dot{u}(r,z,t)v(r,z) drdz = \int_{\Omega} \frac{\partial u(r,z,t)}{\partial t} v(r,z) drdz, \\
    a(t;u,v) &= \int_{\Omega} \left[ \lambda_1(r,z,t) \frac{\partial u}{\partial r} \frac{\partial v}{\partial r} + \lambda_2(r,z,t) \frac{\partial u}{\partial z} \frac{\partial v}{\partial z} \right] \cdot r \cdot drdz + \int_{\Gamma_3} \alpha(r,z,t)u(r,z,t)v(r,z) ds, \\
    \langle F(t),v \rangle &= \int_{\Omega} f(r,z,t)v(r,z) drdz + \int_{\Gamma_2} g_2(r,z,t)v(r,z) ds + \int_{\Gamma_3} \alpha(r,z,t)u_A(r,z,t)v(r,z) ds, \\
    V_{g_1} &= \{u \in H^1(\Omega) : u = g_1 \; in \;  \Gamma_1 \; for \; almost \; every \; t \in (0,T) \} \\
    V_0 &= \{ v \in H^1(\Omega) : v = 0 \; in \; \Gamma_1 \}
\end{align*}

Adapted for the temperature distribution, assuming $\lambda$ and all material parameters are constant, the weak formulation can be described as follows: 

\begin{equation}
    a_w(t;u,v) := \int_{\Omega} \rho c (\partial_t u \cdot v) r drdz + \int_{\Omega} \lambda (\partial_r u \partial_r v + \partial_z u \partial_z v) r drdz = \int_{\Omega} f v r dr dz
\end{equation}

Using the same trial functions as described above (\ref{trial_functions1}) (\ref{trial_functions2}).  \\

For further information on the fully discrete weak formulation, please refer to the work of Jung \cite{jung}.


\subsection{Discretization / Triangulation}

- Grid generation and refinement \\
- 2D domain \\
- initial coarse grid trinagulation can be done by hand \\
- coarse grid can be refined by algorithm \\

- refinement of triangle into 4 new pieces \\
- \textcolor{blue}{insert picture here}



\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{pictures/triangulation_full.PNG}
    \caption{Triangulation on the full cross-section}
    \label{fig:triangulation_full}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{pictures/triangulation_halved_coarse.PNG}
    \caption{Triangulation on the halved cross-section}
    \label{fig:triangulation_halved}
\end{figure}
\subsection{Assembling system of equation}

- assemble elementwise \\
- Approximate elements with linear regression functions\\
- Calculation on reference triangles to speed up performance and accuracy \\

Linear regression functions for reference triangles:
\begin{align}
    \phi_1(\xi, \eta) &= 1 - \xi - \eta \\
    \phi_2(\xi, \eta) &= \xi \\
    \phi_2(\xi, \eta) &= \eta 
\end{align}

- use symmetrie of elements if coefficients are constant or allow it \\
- Add boundary conditions afterwards \\
- grouping of similar calculations allow more vectorized operations \\ 

\subsection{ODE for parabolic problems}

\textcolor{blue}{TODO}

\subsection{Solving the system of equations}
- direct solver would be preferred in general \\
- if numbers of element grows, this computations takes up lots of memory \\
- up from a certain point, high amount memory can't be efficiently handled with RAM anymore \\
- using additional memory is extremely costly in terms of calculation speed \\
- since matrix is sparse, iterative solver can be very fast \\
- iterative solver is preferred if elements grow in numbers \\
- TODO : when should you use iterative solver \\

\subsection{Error estimations}

\subsubsection{Element Error on 2D geometry}
- H1-Norm \\
- L2-Norm \\

- The analytical solution of the problem is unknown, but we can estimate it by calculating different element sizes on different sized fine grids \\

Idea: Define geometric some geometric coordinates on triangle and look for best matching or choose some points on different geometrical entities \\

Refine triangles around that point and see whether the error is smaller on the finer grid \\

\subsubsection{Time step error on discrete intervalls}

See Skript Numerik 2 Kroeger, after some take make a smaller or larger time step and compare the difference of results, use the smaller steps for calculation \\


\newpage


\section{Other numerical aspects }


\subsection{Surface integral}
The surface integral over the individual elements is required for the element by element assembly of the systems of equations. The computation of these takes place on discrete Gauss quadrature points. In this simulation, either 3 or 7 base points were used for the quadrature. More base points increase the calculation effort, but generally result in more precise calculation results. A detailed reference of the method used can be found in the book by Jung \cite{jung}.

\subsection{Numerical gradient on discrete points}
In the Ritz-Galerkin algorithm, the applied trial functions approach the solution of the variation problem. The numerical gradient thus approximately corresponds to the gradients of the approach functions on the element. For this implementation only linear functions were used, accordingly the numerical gradient is constant for each element. In order to obtain an exact numerical result for the gradient on the discrete grid points, a mean value was calculated from the constant gradients of the surrounding elements.


\subsection{Troublesome neighbours}
The joint use of Dirichlet and Neumann boundary conditions can lead to problems at individual points, specifically at the corners of Dirichlet edges to a Neumann edge. In the simulation this problem occurs concretely at the electrodes. Dirichlet nodes are treated by manipulating the equation of the node to a trivial problem. Dirichlet boundary conditions have a higher priority, therefore the common corner node is treated as a Dirichlet boundary condition. Before manipulating the matrix, the result of a matrix-vector multiplication with non-manipulated data is subtracted from the affected parts of the equation system on the right side. This compensates side effects of the following modification. The right side of the equation is set to the Dirichlet value and the corresponding matrix entry gets the value 1. All other variables of the affected row and column vector are set pragmatically to the value 0. This pragmatic procedure is exact for a Dirichlet node and does not require any calculation. However, this procedure has a very negative effect on an adjacent Neumann edge. By artificially modifying the system of equations, the equation for the directly adjacent Neumann node is invalidated. The calculation of the node thus delivers an undefined result. To overcome this problem, it has proved to be useful to ignore the calculated result for this concrete node and to interpolate a substitute result by weighting the results of neighboring nodes. This special implementation has obvious flaws, but achieves relatively good results in practice.



% < Section 7 Applied simulation >


\section{Applied simulation}

\subsection{Reference data}
In order to be able to perform a meaningful simulation, it is necessary to find suitable reference numbers for all variables used. For the determination of material parameters the measurement results from the investigations of Stein \cite{stein} were used. For the description of the electrical generator setup a large number of configurations can be used for this investigation. Concrete data on devices that are commonly used in medical practice can be found in Padma's publication \cite{padma}. 

\subsection{Solving the PDEs}
The electric potential $\varphi$ and the electric power $p$ are calculated in advance, because they are time independent. Therefore, the electrical energy $Q_{rf}$ can easily be obtained by multiplying the power by the step size of the time discretization. Since the thermal equation is inherently very stiff, the implicit Euler method for matrices is used to calculate the discrete solution. For each time step the temperature equation is recomposed and calculated. This results in a coherent time dependent simulation.


\subsection{Graphical output}
The calculated 2D data for $\varphi$, the electrical power and the temperature distribution for each time step can easily be visualized on a 3D plot. Since the calculated cross-section solutions are axisymmetric, the calculated values are valid for every angle $\phi$. From this, a 3D reconstruction can be easily generated by defining concrete angle points. After retransforming the generated solution into cartesian coordinates, the 3D geometry can be visualized on a 4D plot with color gradient depending on the numerical solution.



% < Section 8 Numerical results >

\section{Numerical results}

In the following the numerical simulation results are presented. The calculations were performed with different element sizes and time step sizes on both the half and the whole cross-section. In the MatLab source code all results can be recalculated and further modified in their configuration. Depending on element size and time step size the expected calculation time is between some seconds and several minutes. \\

Basically all calculation results are qualitatively within the expected range. For comparison, we refer to the published results of a very similar simulation with accompanying experiments by Watanabe \cite{watanabe}.

\begin{figure}[H]
    \centering
        \includegraphics[width=0.8\textwidth]{pictures/phi_2D_sideview.PNG}
        \caption{Time-independent numerical solution for $phi$ on a halved 2D cross-section}
        \label{phi_2D_sideview}
\end{figure}


\begin{figure}[H]
    \centering
        \includegraphics[width=0.8\textwidth]{pictures/phi_2D_topview.PNG}
        \caption{Topview of the solution for $\varphi$ on the halve grid}
        \label{phi_2D_topview}
\end{figure}



\begin{figure}[H]
    \centering
    \includegraphics[width=0.8\textwidth]{pictures/phi_3D.PNG}
    \caption{3D reconstruction of the numerical solution for $\varphi$}
    \label{phi_3D}
\end{figure}


- Ellectric power therefore calculated by using numerical gradient of  gradient  

\begin{figure}[H]
    \centering
    \includegraphics[width=0.75\textwidth]{pictures/numericalGradient_2D.PNG}
    \caption{Numerical gradient of the solution for $varphi$}
    \label{numericalGradient_2D}
\end{figure}

- Leading to the applied electric energy  

\begin{figure}[H]
    \centering
    \includegraphics[width=0.75\textwidth]{pictures/effectiveEnergy_2D.PNG}
    \caption{Effective energy applied by the probe in one second}
    \label{effectiveEnergy_2D}
\end{figure}


- Also temperature calculation generally meets expectation \\
- Rises slowly but steady as more electric energy is apllied by the probe \\
- Perfusion distributes the increasing temperature over the domain \\
- TODO compared with other simulations make ref!
- Temperature was calculated up to around 240 seconds \\
- Further calculation would not be reasonable \\
- Temperatures above around 90¬∞ Celsius usually get regulated \\
- Also evaporation of water has great impacts on the material parameters which is not taken into account b the model \\


\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\textwidth]{pictures/temp_2D_240sec.PNG}
    \caption{Temperature distribution after 240 seconds on a coarse halved cross-section}
    \label{temp_2D_240sec}
\end{figure}


\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\textwidth]{pictures/temp_2D_240sec_finer_full.PNG}
    \caption{Temperature distribution after 240 seconds on a fine grid}
    \label{temp_2D_240sec_finer_full}
\end{figure}


\begin{figure}[H]
    \centering
    \includegraphics[width=0.9\textwidth]{pictures/temp_3D_240sec_fine.PNG}
    \caption{3D reconstruction of the temperature distribution after 240 seconds}
    \label{temp_3D_240sec_fine}
\end{figure}



% < Section 9 Summary and outlook >

\section{Summary and outlook}

\subsection{Project Summary}
\subsubsection{A humble simulation}
One could argue, that it is a waste of time to write a numerical simulation from scratch. There are already many very useful software solutions for numerical simulations and these kind of problems in general. Therefore there is usually no need to write your own detailed implementation of the underlying algorithms. \\

However, creating your own scripts and implementations helps to understand numerical problems and sources of error in this type of modeling at all. Even all commercial software is based on algorithms of this kind. Dealing with these problems on one's own greatly improves the ability to use these software products effectively and write great simulations.\\

There can be no good software developer who does not understand how a computer processes numbers. Similarly, this academic approach trains the understanding of numerical simulation. I think, everybody who deals with finite elements should have implemented such algorithms himself at some point. \\

\subsubsection{Strengths and flaws}
It is appropriate at this point to draw a conclusion about the results achieved. \\
Basically the simulation can be regarded as quite good for a study project. 
The numerical results are in good agreement with the general expectation. The calculations converge relatively reliably with reasonable choice of variables.
The chosen implementation is flexible and can therefore easily be adapted to more complex approaches and models. \\
However, the chosen model is far too simplified to be a realistic representation of the conditions of an actual RFA treatment. Further planned modifications are interesting from a mathematical point of view, but would not significantly change the results of the simulation and thus its validity.


\subsubsection{Future modifications}
I plan to expand this project in the future and let the chosen model mature. The described material parameters are in reality strongly non-linearly dependent on the temperature and the surrounding factors. An improved parameterization of these should lead to much more realistic simulation results. Especially the evaporation of water and a more complex formulation of blood perfusion should be considered. Subsequently, more complex and more realistic boundary conditions should be chosen. 
The simulation of a second needle and monopolar probes would also be conceivable. The underlying algorithm can basically be adapted to three-dimensional problems.

%\subsection{State of the current Research}
%- Research in the simulation of medical therapy methods \\
%- TODO \\


\subsection{Other FEM software}

There is a lot of great commercial FEM software available to solve problems of this kind. Matlab, the tool used for this numerical simulation, offers its own PDE toolbox with corresponding libraries with efficient implementation of almost all aspects for solving partial differential equations.

In addition, there are numerous powerful simulation tools, which also offer additional features such as built-in geometric modelers and graphical user interfaces. COMSOL Multiphysics and ANSYS are two of the most widely used tools of their kind in modern industry.

Aside from that, there are a number of powerful free open source software projects that provide a number of highly optimized library functions. Worth mentioning here are the FEniCS project and FreeFEM.


\newpage


%% Literature register using .bib file
\clearpage
\nocite{*}
\printbibliography

\newpage

%% last part, appendix
% \appendix

% \input{Appendix} 

\end{document} 