%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% Template für die Erstellung einer Arbeit an der TH Nürnberg
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% Definition des Grundsätzlichen dokumententyps und -layouts
\documentclass[parskip=half, titlepage=yes, 12pt, BCOR=12mm, DIV=calc]{scrartcl}

% Definition der Praeambel
% Praeambel = Quasi-Klasse mit Definitionen des Layouts
% und Definition einbinden der verwendeten Pakete
\input{Praeambel}


\usepackage{amsthm}
\usepackage{lipsum}

%% Hier startet der eigentliche Dokumenteninhalt
\begin{document}


%% Titelblatt und Verzeichnisse
\maketitle
\tableofcontents

\clearpage

% \listoffigures
% \listoftables
% \lstlistoflistings
% \clearpage


% part 1, Introduction 

\section{Introduction to radio frequency ablation}
Lets talk about:\\
- Medical Treatment of Tumor\\
- Radio frequency ablation\\
- Why RFA Simulation is important \\
- {Motivation / This project in General}\\


% part 2, Main

\section{Computer-aided simulation of radio frequency ablation}

\subsection{Discrete Numerical Simulation}
- In real world physics models are often bounded by reality \\
- Geometrical boundary conditions are often vague \\
- In most cases there is no reasonable analytical approach to solve these problems \\
- Modern numerical approaches are very flexible in this regard \\
- Simulations done right can be easily modified and adapted to different models and boundaries \\

\subsection{About Errors in simulations and numerical approaches}
- see TUM dissertation \\
- There are different sources for errors following the simulation from the line from the real problem down to the discrete solution \\
- Idealization error: discrepancy between reality and the idealized reality and the idealized constitutive laws and boundary conditions -> Systems are often way more complex in reality, every patient is different \\
- Modeling errors: discrepancy between mathematical formulation and physical model -> e.g. using dimensionally reduced approaches, like linear dependencies or even constant parameters  \\
-  Discretization errors: discrepancy between the continous description and discrete discription of the model \\
- Solution errors: using iterative approximation methods and rounding errors \\
- It's basically a butterfly effect \\
- Optimizing one error source often conflicts with another one -> e.g. handling nonlinearity can cause fatal numerical errors (at least that's what Kroeger said ...)


\subsection{The physics behind radio frequency ablation}
- Generating electrical energy with a generator \\
- Generated heat is distributed on the tissue \\
- Temperature rises do to constant electrical energy input \\
- Interesting is: - Temperature distribution over time \\
- What else? TODO \\
- Electrical energy can be approximated by the potential of the electrodes on the probes \\

\begin{equation}
    \varphi: TODO 
\end{equation}

\begin{equation}
    Electrical Energy: TODO
\end{equation}

- No energy is lost \\
- Electrical Energy becomes heat energy by Tissue resistance \\
- Heat Energy is distributed by heat equation \\

\begin{equation}
    Heat equation : TODO 
\end{equation}

- Discretization of the equation in space and time domain \\
- Time can be modeled continuously or in discrete intervalls \\
- Discrete intervalls are is typically more practical in modeling but less efficient or exact \\
- Discrete intervalls can be refined if necessary \\

\section{Mathematical aspects of discrete simulation}

\subsection{Theory of finite elements}

\subsubsection{Elliptical problems}
- Elliptical problems in general \\
- build up system of PDE's to describe problem \\
- Using the cylindric domain, different domains \\

\subsubsection{Parabolic problems}
- Parabolic / time-dependent problems \\
- Ignoring time dependency first and calculate the resulting elliptical problem
- Build system of equations for elliptical problem \\
- Describe the parabolic PDE as an ODE with matrices from elliptical PDE \\
- Solving the system of ODE equations over discrete time intervalls \\
- Runge-Kutta \\
- For this simulation, backward euler / implicit euler formula does the job \\

\subsubsection{FEM in Electrostatics}
- General info \\
- special domain \\
- boundary conditions \\

\subsubsection{FEM in Temperature Fields / perhaps Fluid Dynamics}
- General info \\
- boundary condition (heat source or sink) \\
- In this simulation, heat source is from electrical energy \\

\subsection{Numerical solution of system of ODE's}

\subsection{Axial symmetrie}
- Using axial symmetrie to simplify computations \\
- reducing one dimension 3D -> 2D \\
- problems are qsuivalent \\
- significant savings calculations time and complexity \\
- approach: fourier decomposition in angular direction to reduce dependency on the angular $\varphi$ \\
- using static models, only dependency on space \\
- maybe Torus elements \\




\section{Discretization of PDEs}

\subsection{Computational Domain}
- Using one needle, whole geometry domain is axis symmetric around one needle \\
- Problem can be reduced to 2D problem using ring elements and cylindric coordinates \\
- Eliminate dependency on angular $\phi$ from the calculations \\
- For visualisation, symmetric results can be reconstructed to 3D \\
- Whole calculation will be in cylindric coordinates \\

\subsection{FEM in cylindric Coordinates}
- Rewrite the equations to cylindric coordinates \\
- Calculations are made on a cross-section with angular phi = 0 \\
- Define boundaries -> new artificial boundary around the rotation axis to be taken into consideration \\
- Explain how the new boundary can be treated \\
 
Laplace in cartesian coordinates:
\begin{equation}
    \nabla^2 := \Delta := \frac{\partial^2}{\partial x^2} + \frac{\partial^2}{\partial y^2} + \frac{\partial^2}{\partial z^2}
\end{equation}

Laplace in cylindric coordinates:
\begin{equation}
    \Delta := \frac{\partial^2}{\partial r^2} + \frac{1}{r} \frac{\partial}{\partial r} + \frac{1}{r^2} \frac{\partial^2}{\partial \phi^2} + \frac{\partial^2}{\partial z^2}
\end{equation}

TODO : Write something \\

Laplace in polar coordinates:
\begin{equation}
    \Delta := \frac{\partial^2}{\partial r^2} + \frac{1}{r} \frac{\partial}{\partial r} + \frac{1}{r^2} \frac{\partial^2}{\partial \phi^2}
\end{equation}



\subsection{PDE for Electric potential}

\subsubsection{Weak formulation of the problem}
4 areas can be distinguished from a mathematical point of view \\
- Inner domain \\
- Fixed Potential of electrodes \\
- Outer boundaries with no fixed potential -> Robin \\
- Rotation axis, artificial boundary -> Neumann \\

Constant material parameters: \\

\subsubsection{Inner Domain}

- The electric potential of the inner domain is described as : 

\begin{equation}
    - \nabla \cdot (\sigma(x,y,z,t) \nabla \varphi(x,y,z,t)) = 0
\end{equation}

- Elliptical boundary problem \\
- Assuming constant material parameters: $\nabla \sigma = 0$ \\
- Solution is independent from $\sigma$ so we can cut it out
- Equation becomes Laplaces' equation, phi becomes time independent \\

\begin{equation}
    - \Delta \varphi(x,y,z) = 0
\end{equation}

- Using a cylindric domain, we can use cylinder coordinates (see ref Laplace in cylinder)

\begin{equation}
    - \Delta \varphi(r,\phi,z) = - \frac{1}{r} \frac{\partial \varphi}{\partial r} - \frac{\partial^2 \varphi}{\partial r^2} - \frac{1}{r^2} \frac{\partial^2 \varphi}{\partial \phi^2} -      \frac{\partial^2 \varphi}{\partial z^2}  = 0
\end{equation}

- Since the domain has axis symmetry, the solution for $\varphi$ is independent from the angular $\phi$ \\
- So equation simplifies to 

\begin{equation}
    - \frac{1}{r} \frac{\partial \varphi}{\partial r} - \frac{\partial^2 \varphi}{\partial r^2} - \frac{\partial^2 \varphi}{\partial z^2} = 0
\end{equation}


\subsubsection{Electrodes}

- Potential difference on the electrodes is fixed bx definition \\
- For calculations, potential will be defined as $\pm 1$ \\

\begin{equation}
    \varphi = \pm 1
\end{equation}


\subsubsection{Outer boundary}

- For first try, a simplification with natural boundary conditions

\begin{equation}
    n \cdot \nabla \varphi = 0
\end{equation}

- In cylindrical coordinates
\begin{equation}
    TODO
\end{equation}

\subsubsection{Rotation axis}

- Axis symmetry, so here apply natural neumann bundary conditions TODO \\


\subsection{Calculation of electrical energy}

- $\varphi$ can be calculated on every discrete point \\
- Calculate power for every point \\
- Tissue Resistance \\
- Effective power \\
- Calculate electric energy from electric power \\




\subsection{PDE for temperature Distribution}

\subsubsection{Weak formulation}

From physics above, the temperature distribution is modeled by the heat equation: 

\begin{equation}
    \partial_t (\rho c T) - \nabla \cdot (\lambda \nabla T) = Q
\end{equation}

The heat equation is a well known parabolic partial differential equation. \\

We are assuming $\rho$ and $c$ are constant \\
$\rho$ = density \\
$c$ = specific heat capacity \\
$\lambda$ = thermal conductivity, which is depending on T \\
T = T(r,z,t) = temperature \\
Q = Q(r,z,t) = heat energy \\


Cylindrical coordinates: see 'Transient Heat Transfer in a Partially Cooled Cylindrical Rod' from Lawrence Agbezuge

\begin{equation}
    \rho c \frac{\partial T}{\partial t} -  \frac{d\lambda}{dT} \left[ \left( \frac{\partial T}{\partial r} \right)^2 + \left( \frac{\partial T}{\partial z} \right)^2 \right] - \lambda \left( \frac{\partial^2 T}{\partial r^2} + \frac{1}{r} \frac{\partial T}{\partial r} + \frac{\partial^2 T}{\partial z^2} \right) = Q
\end{equation}

For the first run, we assume $lambda$ is also constant too, which greatly reduces the complexity of the problem to the form

\begin{equation}
    \rho c \frac{\partial T}{\partial t} - \lambda \left( \frac{\partial^2 T}{\partial r^2} + \frac{1}{r} \frac{\partial T}{\partial r} + \frac{\partial^2 T}{\partial z^2} \right) = Q
\end{equation}

\textcolor{red}{TODO: explain Q her}

\begin{equation}
    Q_{total} = Q_{rf} + Q_{perf}
\end{equation}

- $Q_{rf}$ is descripted above \\
- $Q_{perf}$ is blood perfusion \\
- TODO: Maybe explain this in the physics above??? \\






\section{Applied FEM technologies}

\subsection{Weak solutions}
\subsubsection{Electric potential}

Electric potential / Laplace's equation in cylindrical domain:

\begin{equation}
    a_w(u,v) := \int_{\Omega} (\partial_r u \partial_r v + \partial_z u \partial_z v) r drdz = \int_{\Omega} f v r dr dz
\end{equation}

- $u \in H_r^1(\Omega) \cap \{v|_{\Gamma_{0}} = 0 \} $ \\
- $v \in H_r^1(\Omega) \cap \{v|_{\Gamma_{0}} = 0 \} $ \\

Approximate with linear regression functions\\
Linear regression functions for reference triangles:
\begin{align}
    \phi_1(\xi, \eta) &= 1 - \xi - \eta \\
    \phi_2(\xi, \eta) &= \xi \\
    \phi_2(\xi, \eta) &= \eta 
\end{align}

Specific PDE for electric potential, inner domain: 

\begin{equation}
    a_w(u,v) := \int_{\Omega} (\partial_r u \partial_r v + \partial_z u \partial_z v) r drdz = 0 
\end{equation}

\subsubsection{Temperature Distribution}

This is basically the problem above but as a hyperbolic problem \\
Using semidiscrete solution and iterate solution over time \\
We are applying method of the discontinuous galerkein fem \\
For reference see Jung, Langer : Methode der finiten Elemente für Ingenieure, chapter 7.1 \\



Weak formulation for the problem: \\

We are looking for $u(r,z,t) \in V_{g1}$ with $\Dot{u} \in L_2(\Omega)$ for almost every $t \in (0,T)$, so \\ \begin{equation}
(\Dot{u},v)_0 + a(t;u,v) = \langle F(t),v \rangle \; for \; all \; v \in V_0    
\end{equation}
and for amost every $t \in (0, T)$ is the "Anfangsbedingung -> suche englische Formulierung"
\begin{equation}
    (u(r,z,0),v)_0 = (u_0,v)_0 \; for \; all \; v \in V_0
\end{equation}

The formal model above is given by 
\begin{align*}
    (\Dot{u},v)_0 &= \int_{\Omega} \Dot{u}(r,z,t)v(r,z) drdz = \int_{\Omega} \frac{\partial u(r,z,t)}{\partial t} v(r,z) drdz, \\
    a(t;u,v) &= \int_{\Omega} \left[ \lambda_1(r,z,t) \frac{\partial u}{\partial r} \frac{\partial v}{\partial r} + \lambda_2(r,z,t) \frac{\partial u}{\partial z} \frac{\partial v}{\partial z} \right] \cdot r \cdot drdz + \int_{\Gamma_3} \alpha(r,z,t)u(r,z,t)v(r,z) ds, \\
    \langle F(t),v \rangle &= \int_{\Omega} f(r,z,t)v(r,z) drdz + \int_{\Gamma_2} g_2(r,z,t)v(r,z) ds + \int_{\Gamma_3} \alpha(r,z,t)u_A(r,z,t)v(r,z) ds, \\
    V_{g_1} &= TODO, \\
    V_0 &= TODO
\end{align*}

Adapted for the temperature distribution, assuming $\lambda$ and all material parameters are constant: 

\begin{equation}
    a_w(t;u,v) := \int_{\Omega} \rho c (\partial_t u \cdot v) drdz + \int_{\Omega} \lambda (\partial_r u \partial_r v + \partial_z u \partial_z v) r drdz = \int_{\Omega} f v r dr dz
\end{equation}

\newpage

\subsection{Discretization / Triangulation}

\subsubsection{Grid generation}

\subsubsection{Grid refinement}


\subsection{Assembling system of equation}

\subsubsection{Assemble elementwise}
\subsubsection{Add boundary Conditions}

\subsection{Error estimations}
\subsubsection{H1-Norm}
\subsubsection{L2-Norm}
\subsubsection{Maybe energy norm???}

\newpage


\section{Numerical challenges / Numerical aspects in general}
\subsection{Numerical integration}
\subsection{Numerical gradient on discrete points}
\subsection{Surface integral}
\subsection{Grid refinement}
\subsection{Solving the system of equations}




\section{Applied simulation}
\subsection{Generating TestData / Get reference data}
- Material parameters see Stein TODO \\
- Using specification data from electrical generator \\

\subsection{Solving the PDEs}
\subsection{Combine everything to continous time dependent simulation}
\subsection{Interpretation of result numbers}
- Interprete numbers \\
- Compare with data from experiment or other simulations \\
- TODO compare with other simulations \\

\section{Programming technologies}

\subsection{Performance Optimization}
\subsection{MatLab vs C++}
- Could have done the whole simulation using only MATLAB \\
- MATLAB is a scripting language that calls Fortran Subroutines, which are highly efficient in calculating problems of linear algebra \\
- However, MATLAB has to call these subroutines in an efficient way to take these performance advantages \\
- It is extremely easy to write bad and inperformant code in MATLAB, if it is used in the wrong way \\
- Efficient implementation required hardcoding routines and is very stiff \\ 
- To me it was important to write flexible code, that can be easily adapted and extended to try out different modification \\
- This is way easier when using loops and subroutines instead of hard coded implementations, also the code because way more easier to read and fix \\
- So I was going for a combined implementation of MatLab and C++ \\ 
- When using flexible code design, C++ allows performance advantages in using loops etc over MATLAB \\
- However, MATLAB allows easy function hadnling, what makes the algorithms more accessable for the reader \\ 
- In the end I combined the advantages of both languages \\
- MatLab serves as frame for the pre- and postprocessing, like grid generation and graphical output of the numerical results. \\
- Also the scripts serve as a mathematical documentation of the whole simulation for the reader \\
- Computation intense subroutines are done in C++ \\


\subsection{Graphical output}

% part 3, Summary

\section{Summary and Outlook}

\subsection{Project Summary}
- One could argue that writing a simulation from scratch is a waste of time \\
- There are many highly useful numerical software solutions for numerical simulation and numerical problems \\
- Usually there is no need to write an own detailed implementation \\
- Creating own scripts and implementations helps to understand numerical problems and error sources \\
- This approach helps enormously to increase the ability to use these software products effectively and to generate better simulations and is mandatory to improve \\
- There can also be no software developer without understanding how a computer works numbers \\

\subsubsection{strengths and flaws}
- why is it good, why is it bad
- good: numerical results do match the general expectation \\
- bad: model is to simplified to represent real world conditions \\

\subsubsection{future modifications}
- Material parameters are dependent on Temperature and potential -> \\
- Using variable instead of fixed material parameters \\
- Take the evaporation of water into account \\ 
- Different types of perfusion \\
- Defining more realistic and complex boundary conditions \\
- Perhaps a second needle in a 3D simulation \\

\subsection{State of the current Research}
- Research in the simulation of medical therapy methods \\
- 


\subsection{Other FEM projects and software}

- FENICS \\
- COMSOL \\
- ANSYS \\

\newpage


%% Literaturverzeichnis mit allen Einträgen der .bib-Datei
\clearpage
\nocite{*}
\printbibliography

\newpage

%% Letzter Teil, Anhang
\appendix

\input{Appendix} 

\end{document} 